#!/usr/bin/env ruby

require 'thor'
require_relative './webgum_lib/utils'
require_relative './webgum_lib/compta'
require_relative './webgum_lib/sanity'
require_relative './webgum_lib/groq'
require_relative './webgum_lib/svelte'

class Webgum < Thor

  class_option :config, type: :string, default: 'webgum.yml', desc: 'Path to configuration file'

  include Utils

  desc :defaults, "Print default configuration"
  def defaults
    puts <<~YAML
      name: My Project
      style_variables:
        default:
          bg_color: '#ffffff'
          fg_color: '#000000'
          ref_width: 1280
          body_size: 16pxvw
          page_margin: 16pxvw
          gutter: 16pxvw
        tablet:
          ref_width: 768
        mobile:
          ref_width: 375
        desktop:
          ref_width: 1600
      sitemap:
        - label: Home
      schemas:
    YAML
  end

  desc :sitemap_blog, "Print sitemap blog"
  def sitemap_blog
    puts <<~YAML.gsub(/^/, "  ")
      - label: Blog
        pages:
          - label: Article
            multiple: true
    YAML
  end

  desc :cta_schema, "Print CTA schema"
  def cta_schema
    puts <<~YAML.gsub(/^/, "  ")
      - name: cta
        title: Call to Action
        type: object
        fields:
          - name: title
          - name: ctaType
            label: Type
            options:
              list:
                - label: Page
                  value: page
                - label: External URL
                  value: href
                - label: File Download
                  value: download
            validations:
              - required
          - name: page
            type: reference
            to:
              - type: basicPage
            weak: true
            options:
              disableNew: true
            hiddenIf:
              field: ctaType
              isNot:
                - page
          - name: href
            label: URL
            hiddenIf:
              field: ctaType
              isNot:
                - href
          - name: file
            type: file
            hiddenIf:
              field: ctaType
              isNot:
                - download
          - name: targetBlank
            label: Open in new tab
            type: boolean
            validations:
              - required
        defaults:
          ctaType: page
          targetBlank: false
        preview:
          select:
            title: title
            subtitle: ctaType
    YAML
  end

  desc :link_schema, "Print Link schema"
  def link_schema
    puts <<~YAML.gsub(/^/, "  ")
      - name: link
        type: object
        fields:
          - name: title
            validations:
              - required
          - name: href
            label: URL
            validations:
              - required
        preview:
          select:
            title: title
            subtitle: href
    YAML
  end

  desc :asset_schema, "Print Asset schema"
  def asset_schema
    puts <<~YAML.gsub(/^/, "  ")
      - name: asset
        type: object
        fields:
          - name: fileType
            type: string
            options:
              list:
                - label: None
                  value: none
                - label: Image
                  value: image
                - label: Video
                  value: video
            validations:
              - required
          - name: image
            type: image
            hiddenIf:
              field: fileType
              isNot:
                - image
          - name: video
            type: file
            hiddenIf:
              field: fileType
              isNot:
                - video
          - name: imagePortrait
            type: image
            hiddenIf:
              field: fileType
              isNot:
                - image
            description: Optional
          - name: videoPortrait
            type: file
            hiddenIf:
              field: fileType
              isNot:
                - video
            description: Optional
        defaults:
          fileType: image
        preview:
          select:
            title: image.originalFilename
            media: image
    YAML
  end

  desc :meta_fields, "Print Meta schemas"
  def meta_fields
    puts <<~YAML.gsub(/^/, "      ")
      - name: metaTitle
      - name: metaDescription
        type: text
    YAML
  end

  desc :published_field, "Print Published field"
  def published_field
    puts <<~YAML.gsub(/^/, "      ")
      - name: published
        type: boolean
        validations:
          - required
    YAML
  end

  desc :rough_estimate, "Print rough estimate"
  def rough_estimate
    has_sitemap = config['sitemap'] and config['sitemap'].is_a?(Array) and config['sitemap'].any?
    has_modules = config['moduleTypes'] and config['moduleTypes'].is_a?(Array) and config['moduleTypes'].any?
    pages_count = if has_sitemap
      count_sitemap_pages(config['sitemap'])
    else
      0
    end
    puts "The pages/modules ratio is generally around 1/1.3 â€” 1/2.2"
    puts "Bigger projects tend to be closer to 1/1.3"
    if has_sitemap and has_modules
      puts "Ratio for this project is 1/#{ (config['moduleTypes'].size.to_f / pages_count).round(2) }"
    end
    puts
    if has_sitemap
      puts "#{ pages_count } pages"
      puts "#{ 10 * pages_count }h based on pages (better estimate when not many details are known)"
    else
      puts "No sitemap with pages found in configuration."
    end
    puts
    if has_modules
      puts "#{ config['moduleTypes'].size } modules"
      puts "#{ 5 * config['moduleTypes'].size }h based on modules"
    else
      puts "No module types with estimates found in configuration."
    end
  end

  desc :compta, "Compta related commands"
  subcommand :compta, Compta

  desc :sanity, "Sanity related commands"
  subcommand :sanity, Sanity

  desc :groq, "GROQ related commands"
  subcommand :groq, Groq

  desc :svelte, "Svelte related commands"
  subcommand :svelte, Svelte

  private

  def count_sitemap_pages(pages)
    count = 0
    pages.each do |page|
      count += 1
      if page['pages'] and page['pages'].is_a?(Array) and page['pages'].any?
        count += count_sitemap_pages(page['pages'])
      end
    end
    count
  end

end

Webgum.start(ARGV)

